<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grid Cut Studio Â· æƒé™ç®¡ç†ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --apple-blue: #0071e3;
            --apple-orange: #ff9500;
            --apple-bg: #f5f5f7;
            --apple-card: rgba(255, 255, 255, 0.85);
            --apple-text: #1d1d1f;
            --apple-gray: #86868b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: var(--apple-bg);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif;
            color: var(--apple-text);
            -webkit-font-smoothing: antialiased;
            padding-bottom: 80px;
        }

        .container { max-width: 1100px; margin: 0 auto; padding: 0 20px; }

        header { padding: 50px 0 30px; text-align: center; }
        header h1 { font-size: 42px; font-weight: 600; letter-spacing: -0.02em; }
        header p { font-size: 18px; color: var(--apple-gray); margin-top: 8px; }

        .glass-card {
            background: var(--apple-card);
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            border: 1px solid rgba(255,255,255,0.7);
            border-radius: 28px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.04);
            margin-bottom: 40px;
            overflow: hidden;
        }

        .studio-layout { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 40px; padding: 40px; }

        .canvas-section { position: relative; }
        .drop-zone {
            width: 100%; height: 500px; background: #fff; border-radius: 22px;
            display: flex; align-items: center; justify-content: center;
            border: 1px solid rgba(0,0,0,0.05);
            transition: all 0.5s cubic-bezier(0.2, 1, 0.3, 1);
            position: relative; overflow: hidden; cursor: pointer;
        }
        .drop-zone.drag-over { border: 2px solid var(--apple-blue); background: rgba(0,113,227,0.03); transform: scale(1.01); }
        
        canvas { max-width: 96%; max-height: 96%; cursor: crosshair; z-index: 2; border-radius: 4px; }
        
        .upload-ui { text-align: center; pointer-events: none; }
        .upload-ui .icon { font-size: 60px; margin-bottom: 16px; display: block; opacity: 0.8; }
        
        .mode-badge {
            position: absolute; top: 20px; left: 20px; z-index: 10;
            background: var(--apple-orange); color: white; padding: 6px 16px;
            border-radius: 50px; font-size: 13px; font-weight: 600;
            box-shadow: 0 4px 12px rgba(255,149,0,0.3);
            display: flex; align-items: center; gap: 8px;
        }

        .controls { display: flex; flex-direction: column; gap: 24px; }
        .control-group-title { font-size: 11px; font-weight: 700; color: var(--apple-gray); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 10px; }
        
        .stepper-container { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .stepper {
            background: #fff; padding: 12px 16px; border-radius: 16px;
            display: flex; align-items: center; justify-content: space-between;
            border: 1px solid rgba(0,0,0,0.04);
        }
        .stepper button {
            width: 32px; height: 32px; border-radius: 50%; border: none;
            background: var(--apple-bg); color: var(--apple-text);
            font-size: 18px; cursor: pointer; transition: 0.2s;
        }
        .stepper button:hover { background: #e8e8ed; }
        .stepper input { border: none; width: 30px; text-align: center; font-size: 16px; font-weight: 600; }

        .instant-preview { background: rgba(0,0,0,0.02); border-radius: 20px; padding: 20px; }
        #previewContainer {
            width: 100%;
            background: #fff;
            border: 1px solid rgba(0,0,0,0.05);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            transition: height 0.3s ease;
        }
        .preview-placeholder { 
            position: absolute; inset: 0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--apple-gray); font-size: 12px; gap: 8px; text-align: center; padding: 20px;
        }
        .thumb-grid {
            display: grid; 
            width: 100%; height: 100%;
            gap: 2px;
            padding: 2px;
        }
        .thumb-item { width: 100%; height: 100%; background: #f0f0f0; overflow: hidden; }
        .thumb-item img { width: 100%; height: 100%; object-fit: cover; }

        .btn {
            padding: 14px 20px; border-radius: 14px; font-size: 15px; font-weight: 600;
            cursor: pointer; border: none; transition: all 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary { background: var(--apple-blue); color: #fff; }
        .btn-primary:hover { background: #0077ed; transform: translateY(-1px); }
        .btn-secondary { background: #fff; color: var(--apple-text); border: 1px solid #d2d2d7; }
        .btn-ghost { background: transparent; color: var(--apple-blue); font-size: 13px; font-weight: 600; padding: 4px 8px; cursor: pointer; border: none; }

        .result-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(210px, 1fr)); gap: 20px; margin-top: 20px; }
        .result-card {
            background: #fff; border-radius: 20px; padding: 10px;
            position: relative; transition: 0.3s cubic-bezier(0.2, 1, 0.3, 1);
            border: 1px solid rgba(0,0,0,0.03); cursor: pointer;
        }
        .result-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.05); }
        .result-card.selected { border: 2.5px solid var(--apple-blue); background: rgba(0,113,227,0.02); }
        .result-card.selected::before {
            content: "âœ“"; position: absolute; top: -8px; left: -8px;
            width: 24px; height: 24px; background: var(--apple-blue);
            color: white; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; font-weight: bold; font-size: 12px; z-index: 5;
        }

        .result-card img { width: 100%; border-radius: 14px; display: block; pointer-events: none; }
        .card-actions {
            position: absolute; top: 15px; right: 15px;
            display: flex; flex-direction: column; gap: 6px;
            opacity: 0; transform: translateX(8px); transition: 0.3s; z-index: 10;
        }
        .result-card:hover .card-actions { opacity: 1; transform: translateX(0); }
        .action-btn { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-download { background: var(--apple-blue); color: white; }
        .btn-resplit { background: var(--apple-orange); color: white; }

        .hidden { display: none !important; }
        svg { width: 18px; height: 18px; fill: none; stroke: currentColor; stroke-width: 2.2; stroke-linecap: round; stroke-linejoin: round; }
    </style>

    <script
      async
      crossorigin="anonymous"
      data-clerk-publishable-key="pk_test_dml0YWwtbWFydGVuLTQ2LmNsZXJrLmFjY291bnRzLmRldiQ"
      src="https://vital-marten-46.clerk.accounts.dev/npm/@clerk/clerk-js@5/dist/clerk.browser.js"
      type="text/javascript"
    ></script>
</head>
<body>

<div class="container">
    <header>
        <h1>Grid Cut Studio</h1>
        <p>ä¸“ä¸šã€çº¯ç²¹çš„å½±åƒæ‹†è§£å·¥å…·</p>
    </header>

    <div style="display: flex; justify-content: center; margin-bottom: 24px; min-height: 40px;">
        <div id="user-button"></div>
    </div>

    <div class="glass-card">
        <div class="studio-layout">
            <div class="canvas-section">
                <div class="drop-zone" id="dropZone">
                    <div id="uploadUI" class="upload-ui">
                        <span class="icon">ô€ˆ„</span>
                        <p style="font-weight: 600; font-size: 18px;">æ·»åŠ ç…§ç‰‡</p>
                        <p style="color: var(--apple-gray); font-size: 14px; margin-top: 4px;">æˆ–æ‹–æ‹½è‡³æ­¤</p>
                    </div>
                    <div id="modeTag" class="mode-badge hidden">
                        <svg viewBox="0 0 24 24"><circle cx="6" cy="7" r="3"/><circle cx="6" cy="17" r="3"/><path d="M20 4L8.12 15.88M14.47 14.48L20 20M8.12 8.12L12 12"/></svg>
                        äºŒæ¬¡åˆ‡å‰²æ¨¡å¼
                    </div>
                    <canvas id="mainCanvas" class="hidden"></canvas>
                </div>
                <input type="file" id="fileIn" class="hidden" accept="image/*">
            </div>

            <div class="controls">
                <button class="btn btn-secondary" onclick="document.getElementById('fileIn').click()">å¯¼å…¥å›¾ç‰‡</button>

                <div>
                    <p class="control-group-title">è¡Œåˆ—è®¾å®š</p>
                    <div class="stepper-container">
                        <div class="stepper">
                            <button onclick="updateGrid('rows', -1)">-</button>
                            <input type="number" id="rowsInput" value="3" readonly>
                            <button onclick="updateGrid('rows', 1)">+</button>
                        </div>
                        <div class="stepper">
                            <button onclick="updateGrid('cols', -1)">-</button>
                            <input type="number" id="colsInput" value="3" readonly>
                            <button onclick="updateGrid('cols', 1)">+</button>
                        </div>
                    </div>
                </div>

                <div class="instant-preview">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <p class="control-group-title" style="margin:0">æ•ˆæœé¢„è§ˆ</p>
                        <button class="btn-ghost" onclick="renderPreview()">ç”Ÿæˆé¢„è§ˆ</button>
                    </div>
                    <div id="previewContainer" style="height: 120px;">
                        <div id="previewInner" style="height: 100%;">
                            <div class="preview-placeholder">
                                <svg viewBox="0 0 24 24" style="stroke: #d2d2d7; width:24px;"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                                <span>ç‚¹å‡»æŸ¥çœ‹æ¯”ä¾‹é¢„è§ˆ</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="actionArea">
                    <div id="normalBtns">
                        <button class="btn btn-primary" style="width:100%" onclick="confirmSplit()">ç¡®è®¤æ‹†åˆ†</button>
                    </div>
                    <div id="secondaryBtns" class="hidden" style="display:flex; gap:12px;">
                        <button class="btn btn-primary" style="flex:1; background:var(--apple-orange)" onclick="confirmSecondary()">å®Œæˆåˆ‡å‰²</button>
                        <button class="btn btn-secondary" style="width:80px; color:#ff3b30" onclick="cancelSecondary()">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:20px;">
        <h2 style="font-size: 26px; font-weight: 600;">å·²æ‹†åˆ†åˆ‡ç‰‡</h2>
        <div style="display:flex; gap:12px;">
            <button id="selectedDownloadBtn" class="btn btn-primary" style="border-radius:40px; padding:8px 24px; font-size:14px; opacity: 0.5; pointer-events: none;" onclick="downloadSelected()">ä¸‹è½½é€‰ä¸­ (0)</button>
            <button class="btn btn-secondary" style="border-radius:40px; padding:8px 20px; font-size:14px;" onclick="downloadAll()">å…¨éƒ¨æ‰“åŒ…ä¸‹è½½</button>
        </div>
    </div>
    
    <div class="result-grid" id="resultGrid"></div>
</div>

<script>
    // ==========================================
    // ã€ä¼šå‘˜ç®¡ç†ä¸­å¿ƒã€‘åœ¨æ­¤ä¿®æ”¹å…è®¸ä½¿ç”¨çš„é‚®ç®±
    // ==========================================
    const MEMBER_WHITELIST = [
        "zhuangshanmeizi@gmail.com", // å¡«å…¥ä½ çš„é‚®ç®±
        "friend@example.com"    // 766307121@qq.com
    ];

    let originalImage = null, linesX = [], linesY = [];
    let isDragging = false, dragAxis = null, dragIndex = -1;
    let secondaryMode = false, selectedRegion = null;

    const canvas = document.getElementById('mainCanvas'), ctx = canvas.getContext('2d');
    const fileIn = document.getElementById('fileIn'), dropZone = document.getElementById('dropZone');

    // åŸºç¡€åŠŸèƒ½é€»è¾‘ä¿æŒä¸å˜...
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
    dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('drag-over'); });
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault(); dropZone.classList.remove('drag-over');
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) handleFile(file);
    });
    dropZone.onclick = (e) => { if(e.target === dropZone || e.target.closest('.upload-ui')) fileIn.click(); };
    fileIn.onchange = (e) => { if(e.target.files[0]) handleFile(e.target.files[0]); };

    function handleFile(file) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            const img = new Image();
            img.onload = () => {
                originalImage = img;
                document.getElementById('uploadUI').classList.add('hidden');
                canvas.classList.remove('hidden');
                cancelSecondary();
                initLines(img.width, img.height);
                draw();
                resetPreview();
            };
            img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    }

    function initLines(w, h) {
        const r = parseInt(document.getElementById('rowsInput').value);
        const c = parseInt(document.getElementById('colsInput').value);
        linesX = []; linesY = [];
        for(let i=1; i<c; i++) linesX.push((w/c)*i);
        for(let i=1; i<r; i++) linesY.push((h/r)*i);
    }

    function updateGrid(type, delta) {
        const input = document.getElementById(type + 'Input');
        input.value = Math.max(1, Math.min(10, parseInt(input.value) + delta));
        if(originalImage) {
            secondaryMode ? initLines(selectedRegion.w, selectedRegion.h) : initLines(originalImage.width, originalImage.height);
            draw();
            resetPreview();
        }
    }

    function draw() {
        if(!originalImage) return;
        if(secondaryMode) {
            canvas.width = selectedRegion.w; canvas.height = selectedRegion.h;
            ctx.drawImage(originalImage, selectedRegion.x, selectedRegion.y, selectedRegion.w, selectedRegion.h, 0, 0, selectedRegion.w, selectedRegion.h);
            ctx.strokeStyle = '#ff9500';
        } else {
            canvas.width = originalImage.width; canvas.height = originalImage.height;
            ctx.drawImage(originalImage, 0, 0);
            ctx.strokeStyle = '#0071e3';
        }
        ctx.setLineDash([12, 6]); ctx.lineWidth = Math.max(3, canvas.width / 350);
        linesX.forEach(x => { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke(); });
        linesY.forEach(y => { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke(); });
    }

    function resetPreview() {
        const container = document.getElementById('previewContainer');
        container.style.height = '120px';
        document.getElementById('previewInner').innerHTML = `
            <div class="preview-placeholder">
                <svg viewBox="0 0 24 24" style="stroke: #d2d2d7; width:20px;"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                <span>ç‚¹å‡»ç”Ÿæˆé¢„è§ˆ</span>
            </div>
        `;
    }

    function renderPreview() {
        if(!originalImage) return;
        const container = document.getElementById('previewContainer');
        const inner = document.getElementById('previewInner');
        const currentW = secondaryMode ? selectedRegion.w : originalImage.width;
        const currentH = secondaryMode ? selectedRegion.h : originalImage.height;
        const ratio = currentH / currentW;
        const newHeight = Math.min(300, container.offsetWidth * ratio);
        container.style.height = newHeight + 'px';
        const rows = parseInt(document.getElementById('rowsInput').value);
        const cols = parseInt(document.getElementById('colsInput').value);
        inner.innerHTML = `<div class="thumb-grid" id="thumbGrid" style="grid-template-columns: repeat(${cols}, 1fr); grid-template-rows: repeat(${rows}, 1fr);"></div>`;
        const grid = document.getElementById('thumbGrid');
        const sortedX = [0, ...[...linesX].sort((a,b)=>a-b), canvas.width];
        const sortedY = [0, ...[...linesY].sort((a,b)=>a-b), canvas.height];
        for(let i=0; i<sortedY.length-1; i++) {
            for(let j=0; j<sortedX.length-1; j++) {
                const w = sortedX[j+1] - sortedX[j], h = sortedY[i+1] - sortedY[i];
                if(w<1 || h<1) continue;
                const off = document.createElement('canvas'); off.width = w; off.height = h;
                const bx = secondaryMode ? selectedRegion.x + sortedX[j] : sortedX[j];
                const by = secondaryMode ? selectedRegion.y + sortedY[i] : sortedY[i];
                off.getContext('2d').drawImage(originalImage, bx, by, w, h, 0, 0, w, h);
                const div = document.createElement('div');
                div.className = 'thumb-item';
                div.innerHTML = `<img src="${off.toDataURL('image/png')}">`;
                grid.appendChild(div);
            }
        }
    }

    function toggleSelect(card) { card.classList.toggle('selected'); updateSelectionUI(); }
    function updateSelectionUI() {
        const selected = document.querySelectorAll('.result-card.selected');
        const btn = document.getElementById('selectedDownloadBtn');
        btn.innerText = `ä¸‹è½½é€‰ä¸­ (${selected.length})`;
        btn.style.opacity = selected.length > 0 ? '1' : '0.5';
        btn.style.pointerEvents = selected.length > 0 ? 'auto' : 'none';
    }

    function confirmSplit(bx=0, by=0) {
        if(!originalImage) return;
        const grid = document.getElementById('resultGrid');
        if(!secondaryMode) grid.innerHTML = '';
        const sortedX = [0, ...[...linesX].sort((a,b)=>a-b), canvas.width];
        const sortedY = [0, ...[...linesY].sort((a,b)=>a-b), canvas.height];
        for(let i=0; i<sortedY.length-1; i++) {
            for(let j=0; j<sortedX.length-1; j++) {
                const w = sortedX[j+1] - sortedX[j], h = sortedY[i+1] - sortedY[i];
                const curX = bx + sortedX[j], curY = by + sortedY[i];
                const off = document.createElement('canvas'); off.width = w; off.height = h;
                off.getContext('2d').drawImage(originalImage, curX, curY, w, h, 0, 0, w, h);
                const url = off.toDataURL();
                const card = document.createElement('div');
                card.className = 'result-card';
                card.onclick = (e) => { if(!e.target.closest('.action-btn')) toggleSelect(card); };
                card.innerHTML = `<img src="${url}"><div class="card-actions"><div class="action-btn btn-download" onclick="downloadUrl('${url}')"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg></div><div class="action-btn btn-resplit" onclick="startSecondary(${curX},${curY},${w},${h})"><svg viewBox="0 0 24 24"><circle cx="6" cy="7" r="3"/><circle cx="6" cy="17" r="3"/><path d="M20 4L8.12 15.88M14.47 14.48L20 20M8.12 8.12L12 12"/></svg></div></div>`;
                grid.appendChild(card);
            }
        }
        updateSelectionUI();
    }

    async function downloadSelected() { const imgs = document.querySelectorAll('.result-card.selected img'); if(imgs.length > 0) await bundleZip(imgs, 'Selected'); }
    async function downloadAll() { const imgs = document.querySelectorAll('.result-grid img'); if(imgs.length > 0) await bundleZip(imgs, 'Full_Export'); else alert('è¯·å…ˆæ‹†åˆ†å›¾ç‰‡'); }
    async function bundleZip(imgNodes, fileName) {
        const zip = new JSZip();
        imgNodes.forEach((img, i) => zip.file(`piece_${i+1}.png`, img.src.split(',')[1], {base64:true}));
        const blob = await zip.generateAsync({type:'blob'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${fileName}.zip`; a.click();
    }

    function getMouse(e) { const rect = canvas.getBoundingClientRect(); return { x: (e.clientX - rect.left) * (canvas.width / rect.width), y: (e.clientY - rect.top) * (canvas.height / rect.height) }; }
    canvas.onmousedown = (e) => {
        const p = getMouse(e), t = canvas.width / 40;
        linesX.forEach((x, i) => { if(Math.abs(p.x - x) < t) { isDragging = true; dragAxis = 'x'; dragIndex = i; } });
        if(!isDragging) linesY.forEach((y, i) => { if(Math.abs(p.y - y) < t) { isDragging = true; dragAxis = 'y'; dragIndex = i; } });
    };
    window.onmousemove = (e) => {
        if(isDragging) {
            const p = getMouse(e);
            if(dragAxis === 'x') linesX[dragIndex] = Math.max(5, Math.min(canvas.width-5, p.x));
            else linesY[dragIndex] = Math.max(5, Math.min(canvas.height-5, p.y));
            draw(); resetPreview();
        }
    };
    window.onmouseup = () => { isDragging = false; };
    function startSecondary(x, y, w, h) { secondaryMode = true; selectedRegion = {x, y, w, h}; document.getElementById('normalBtns').classList.add('hidden'); document.getElementById('secondaryBtns').classList.remove('hidden'); document.getElementById('modeTag').classList.remove('hidden'); initLines(w, h); draw(); resetPreview(); window.scrollTo({top: 0, behavior: 'smooth'}); }
    function confirmSecondary() { confirmSplit(selectedRegion.x, selectedRegion.y); cancelSecondary(); }
    function cancelSecondary() { secondaryMode = false; selectedRegion = null; document.getElementById('normalBtns').classList.remove('hidden'); document.getElementById('secondaryBtns').classList.add('hidden'); document.getElementById('modeTag').classList.add('hidden'); if(originalImage) { initLines(originalImage.width, originalImage.height); draw(); resetPreview(); } }
    window.downloadUrl = (url) => { const a = document.createElement('a'); a.href = url; a.download = `slice.png`; a.click(); };

    // ==========================================
    // ã€æƒé™é”å®šé€»è¾‘ã€‘
    // ==========================================
    function applyLock(type) {
        const actionArea = document.getElementById('actionArea');
        if (!actionArea) return;

        // å½»åº•æ¸…é™¤æ—§æç¤º
        const oldTip = document.getElementById('login-tip');
        if(oldTip) oldTip.remove();

        if (type === 'NOT_LOGGED_IN') {
            actionArea.style.opacity = "0.2";
            actionArea.style.pointerEvents = "none";
            actionArea.style.filter = "grayscale(100%)";
            showTip("ğŸ”’ <b>åŠŸèƒ½å·²é”å®š</b><br><small>è¯·å…ˆåœ¨é¡µé¢ä¸Šæ–¹ç™»å½•è´¦å·</small>");
        } else if (type === 'NOT_MEMBER') {
            actionArea.style.opacity = "0.2";
            actionArea.style.pointerEvents = "none";
            actionArea.style.filter = "grayscale(100%)";
            showTip("ğŸš« <b>æš‚æ— ä¼šå‘˜æƒé™</b><br><small>è¯·è”ç³»ç®¡ç†å‘˜å¼€é€šæƒé™</small>");
        } else {
            // è§£é”
            actionArea.style.opacity = "1";
            actionArea.style.pointerEvents = "auto";
            actionArea.style.filter = "none";
        }
    }

    function showTip(msg) {
        const actionArea = document.getElementById('actionArea');
        const tip = document.createElement('p');
        tip.id = "login-tip";
        tip.innerHTML = msg;
        tip.style.cssText = "color:var(--apple-orange); text-align:center; margin-bottom:15px; background:rgba(255,149,0,0.1); padding:10px; border-radius:12px; font-size:14px; line-height:1.6";
        actionArea.prepend(tip);
    }

    window.addEventListener('load', async function () {
        if (window.Clerk) {
            await Clerk.load();
            const userButtonDiv = document.getElementById('user-button');

            if (Clerk.user) {
                // 1. å·²ç™»å½•
                Clerk.mountUserButton(userButtonDiv);
                const userEmail = Clerk.user.primaryEmailAddress.emailAddress;
                
                // 2. æ£€æŸ¥æ˜¯å¦åœ¨ç™½åå•
                if (MEMBER_WHITELIST.includes(userEmail)) {
                    applyLock('UNLOCK');
                    console.log("æƒé™éªŒè¯é€šè¿‡:", userEmail);
                } else {
                    applyLock('NOT_MEMBER');
                    console.log("éä¼šå‘˜ç”¨æˆ·:", userEmail);
                }
            } else {
                // 3. æœªç™»å½•
                Clerk.mountSignIn(userButtonDiv);
                applyLock('NOT_LOGGED_IN');
            }
        }
    });
</script>
</body>

</html>


